<!DOCTYPE html>
<html lang="zh">
<head>
    <title>Tincat TV</title>
    <link rel="Shortcut Icon" href="drawable/icon.png" type="image/png" />

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>

    <link href="../common/h5.css" rel="stylesheet"/>

    <script src="../common/h5.js"></script>
    <script src="../common/vue.min.js"></script>
    <script src="../common/tincat.js"></script>
    <script src="libs/context.js"></script>
</head>

<body>
<div id="app">
    <div class="h5-actionbar">
        <img @click="history.back();" src="drawable/icon_back.svg"/>
        <div>Channel List</div>
    </div>

    <div style="padding-top: 50px;">
        <div @click="play(it.url)" v-for="it,index in channelArray" class="h5-selector" style="height: 50px; display: flex; align-items: center;padding: 0px 4px 0px 16px;">
            <div>
                <img src="drawable/channel.svg" style="width: 22px; height: 22px;"/>
            </div>
            <div class="h5-singleline" style="flex-grow: 1;padding: 0px 8px 0px 16px;">{{it.name}}</div>
            <div>
                <img @click.stop="add(index)" src="drawable/add.svg" style="width: 44px; height: 44px;padding: 12px;"/>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    new Vue({
        el: "#app",

        data: function()
        {
            return {
                channelArray: []
            };
        },

        mounted: function()
        {
            this.url = decodeURIComponent(h5.util.getParameter("url"));
            this.getData();
        },

        methods: {
            getData: function()
            {
                var that = this;
                tincat.http.get({
                    url: this.url,
                    mask: true,
                    callback: function(result)
                    {
                        try
                        {
                            var lines = result.split("\n");

                            // 解析m3u
                            var channelArray = [];
                            var channel = {};
                            for(var i = 0; i < lines.length; i++)
                            {
                                var line = lines[i];
                                if(line.length === 0)
                                {
                                    continue;
                                }

                                if(line.indexOf("#EXTINF") === 0)
                                {
                                    channel.name = line.split(",")[1];
                                }
                                else
                                {
                                    channel.url = line;
                                    if(channel.name && channel.url)
                                    {
                                        channelArray.push(channel);
                                    }
                                    channel = {};
                                }
                            }

                            that.channelArray = channelArray;
                        }
                        catch(e)
                        {
                            toast("error m3u");
                        }
                    },
                    failCallback: function()
                    {
                        toast("network error");
                    }
                });
            },

            add: function(index)
            {
                if(confirm("add to your channel list?"))
                {
                    tincat.http.restful({
                        url: Api.tincat_tv_addChannel_v1,
                        body: {
                            title: this.channelArray[index].name,
                            url: this.channelArray[index].url
                        },
                        mask: true,
                        callback: function()
                        {
                            tincat.system.toast("Add Success, need refresh your channel list");
                        }
                    });
                }
            },

            play: function(url)
            {
                location.href = "test.html?url=" + encodeURIComponent(url);
            }
        }
    });
</script>
</html>